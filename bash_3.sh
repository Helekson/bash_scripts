#!/bin/bash

# Функция для вывода инструкции по использованию
print_help() {
  echo "Использование: $0 [-d каталог] [-e файл_ошибок]"
  echo "  -d каталог     Указать каталог, в котором считать файлы (по умолчанию текущий каталог)."
  echo "  -e файл_ошибок Перенаправить сообщения об ошибках в указанный файл."
  echo "  -h             Показать эту инструкцию."
}

# Функция для подсчета файлов в каталоге
count_files() {
  local dir=$1
  if [[ -d "$dir" ]]; then
    file_count=$(find "$dir" -type f | wc -l)
    echo "Количество файлов в каталоге '$dir' (включая подкаталоги): $file_count"
  else
    echo "Ошибка: Каталог $dir не существует." >&2
  fi
}

# Обработчик аргументов
directory="."
error_file=""
while getopts "d:e:h" opt; do
  case "$opt" in
    d) # Обработка ключа -d для указания каталога
      directory="$OPTARG"
      ;;
    e) # Обработка ключа -e для указания файла ошибок
      error_file="$OPTARG"
      ;;
    h) # Обработка ключа -h для вывода инструкции
      print_help
      exit 0
      ;;
    *)
      echo "Неверный параметр. Используйте -h для справки." >&2
      exit 1
      ;;
  esac
done

# Перенаправление ошибок в файл, если указан ключ -e
if [[ -n "$error_file" ]]; then
  exec 2>"$error_file"
fi

# Переход в указанный каталог
cd "$directory" || { echo "Ошибка: Не удалось перейти в каталог $directory." >&2; exit 1; }

# Подсчет файлов
count_files "$directory"
